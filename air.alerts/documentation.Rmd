---
title: "Documentation for AirAware text alert scripts"
author: "Lisa Oshita"
date: "May 4, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Requirements for alert.py

The latest version of python needs to be installed.

1. Download python [here](https://www.python.org/downloads/)
2. On the first screen of the python installer, the option "Add Python 3.6 to PATH" must be enabled
3. Click "Install Now"

Python packages, twilio and pandas, also need to be installed.

1. Open the command prompt
2. Type "pip install twilio"
3. Type "pip install pandas"

The file containing the subscriber phone numbers must be in CSV format.



# How text.alert() works:

* The function text.alert() (in send.alert.R) takes the name of the pm10 excel file as a character string argument. * The function checks if the dates in the file are equal to the current date. If not, the function stops.
* If the dates are current, the function sets all pm10 values that are greater than 800 to NA.
* It also sets any pm10 values that are greater than 175 that occurred before 8:00am, to NA.
* Then the function checks if all values of pm10 are less than 175. If true, the function stops. 
* If not (there are pm10 values greater than 175), the function reads in the log of text messages sent, named alert.log.csv. 
* If a text was already sent that day, the function stops. 
* If a text was not sent, the function intializes an empty data frame that will be used later on to store text information. 
* The function then creates a batch file that calls and executes alert.py. This batch file is ran with the system2 function. The output of this call is saved to "run". Output will be either a 0 if alert.py executed without error, or a 1 if there was an error. If there was an error, texts were not sent out. See below for some reasons why this script might have executed in an error. 
* If run is equal to 1, this indicates that texts were not sent out. The function stops here. 
* If run is equal to 0, texts were successfully sent out. The message log will be updated with the current date and time. 
* Lastly, the function will unlink the batch file created earlier. 



# How alert.py works: 

* The script imports the twilio and pandas libraries.
* The function, main(), reads in the csv of subscriber phone numbers. Only the columns "PHONE" and "DUST" will be read in. The dtype argument of this function specifies that columns will be read in as character strings (str). 
* The function then removes all white spaces and all text is converted to lower case in the DUST column.
* The function then saves all phone numbers that are complete (have at least 10 digits) and also have indicated "yes" in the DUST column. 
* Leading ones are added to the phone numbers that don't have a leading one (numbers with less than 11 digits).
* All phone numbers are then concatenated to the rest of the address string. 
* The string of addresses are then converted to a list called "full". 
* The function then sends the SMS messages using that list. 

The code snippet at the very bottom of the python script just streamlines the process of calling this python script. Specifically, if alert.py is called, the main function is automatically ran (no need to call main() within alert.py). 



### Reasons why texts might fail to send

* Account SID, Token, Service SID might be incorrect.

