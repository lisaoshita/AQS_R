---
title: "Documentation for AirAware text alert scripts"
author: "Lisa Oshita"
date: "May 4, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Requirements for alert.py

The latest version of python needs to be installed.

1. Download python [here](https://www.python.org/downloads/)
2. On the first screen of the python installer, the option "Add Python 3.6 to PATH" must be enabled
3. Click "Install Now"

Python packages, twilio, pandas and xlrd also need to be installed.

1. Open the command prompt
2. Type "pip install twilio"
3. Type "pip install pandas"
4. Type "pip install xlrd"


# How text.alert() works:

* The function text.alert() (in send.alert.R) takes the name of the pm10 excel file as a character string argument.
* The function checks if the dates in the file are equal to the current date. If not, the function stops.
* If the dates are current, the function sets all pm10 values that are greater than 800 to NA.
* It also sets any pm10 values that are greater than 175, that also occurred before 8:00am, to NA.
* The function then checks if all values of pm10 are less than 175. If true, the function stops. 
* If not (there are pm10 values greater than 175), the function reads in alert.log.csv, the log of text messages sent. 
* The function stops if a text had already been sent that day.  
* If a text was not sent earlier in the day, the function intializes an empty data frame that will be used later on to store text information. 
* The function then creates a batch file called 774R3UvON5.bat, that calls and executes alert.py. This batch file is ran with the system2 function. The output of this call is saved to the variable "run". Output will be a 0 if alert.py executed without error, or a 1 if there was an error. If there was an error, texts were not successfully sent out (see below for some reasons why alert.py might have executed in an error).
* The function stops if run is equal to 1. 
* If run is equal to 0 (texts were successfully sent out), the message log will be updated with the current date and time. 
* Lastly, the function will unlink the batch file created earlier. 



# How alert.py works: 

* The script imports the twilio and pandas libraries.
* The function, main(), reads in an excel file of subscriber phone numbers. Only PHONE and DUST columns, corresponding to columns A and C in the file, will be read in. The dtype argument of this function specifies that columns will be read in as character strings (str). 
* Function performs a series of string manipulation techniques to put together the addresses texts will send to:
    + All white spaces are removed and all text is converted to lower case in the DUST column.
    + The function then saves all phone numbers that are complete (have at least 10 digits) and have also indicated "yes" in the DUST column. 
    + Leading ones are added to the phone numbers that don't have a leading one (numbers with less than 11 digits).
    + All phone numbers are then concatenated to the rest of the address string, and then converted into a list called "full".
* The function then sends the SMS messages using that list. 

The code snippet at the very bottom of the python script just streamlines the process of calling this script. Specifically, if alert.py is called, the main function is automatically ran (no need to call main() within alert.py).



### Reasons why texts might fail to send

* Account SID, Token, Service SID might be incorrect.

